name: Release Build and Publish

on:
  workflow_dispatch:
    inputs:
      target_ref:
        description: 'Git tag or commit to build and publish'
        required: true
        type: string

permissions:
  contents: write

jobs:
  resolve-metadata:
    runs-on: ubuntu-22.04
    outputs:
      tag: ${{ steps.metadata.outputs.tag }}
      commit: ${{ steps.metadata.outputs.commit }}
      release_name: ${{ steps.metadata.outputs.release_name }}
    
    steps:
      - name: Resolve release metadata
        id: metadata
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const rawTag = context.payload.inputs.target_ref;
            if (!rawTag) {
              core.setFailed('target_ref input is required. Please provide a git tag or commit to build.');
              return;
            }

            const normalizedTag = rawTag.replace(/^refs\/tags\//, '').replace(/^refs\//, '');
            const refPath = normalizedTag.startsWith('tags/') ? normalizedTag : `tags/${normalizedTag}`;

            let refData;
            try {
              refData = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: refPath,
              });
            } catch (error) {
              core.setFailed(`Failed to resolve ${refPath}: ${error.message}`);
              return;
            }

            let commitSha = refData.data.object.sha;
            if (refData.data.object.type === 'tag') {
              const annotated = await github.rest.git.getTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_sha: commitSha,
              });
              commitSha = annotated.data.object.sha;
            }

            core.setOutput('tag', normalizedTag);
            core.setOutput('commit', commitSha);
            core.setOutput('release_name', normalizedTag);

  build-linux:
    needs: [resolve-metadata]
    uses: ./.github/workflows/build-linux.yml
    with:
      target_ref: ${{ needs.resolve-metadata.outputs.tag }}
      plugins: 'base,good,bad,ugly,libav'
      features: 'gpl,webrtc'
      build_type: 'release'

  build-windows-mingw:
    needs: [resolve-metadata]
    uses: ./.github/workflows/build-windows-mingw.yml
    with:
      target_ref: ${{ needs.resolve-metadata.outputs.tag }}
      plugins: 'base,good,bad,ugly,libav'
      features: 'gpl,webrtc'
      build_type: 'release'

  build-windows-msvc:
    needs: [resolve-metadata]
    uses: ./.github/workflows/build-windows-msvc.yml
    with:
      target_ref: ${{ needs.resolve-metadata.outputs.tag }}
      plugins: 'base,good,bad,ugly,libav'
      features: 'gpl,webrtc'
      build_type: 'release'

  build-macos:
    needs: [resolve-metadata]
    uses: ./.github/workflows/build-macos.yml
    with:
      target_ref: ${{ needs.resolve-metadata.outputs.tag }}
      plugins: 'base,good,bad,ugly,libav'
      features: 'gpl,webrtc'
      build_type: 'release'

  verify-plugins:
    needs: [build-linux]
    if: always() && (needs.build-linux.result == 'success')
    uses: ./.github/workflows/verify-plugins.yml

  publish-to-release:
    needs: [resolve-metadata, build-linux, build-windows-mingw, build-windows-msvc, build-macos, verify-plugins]
    if: always()
    uses: ./.github/workflows/create-release.yml
    with:
      tag_name: ${{ needs.resolve-metadata.outputs.tag }}
      release_name: ${{ needs.resolve-metadata.outputs.release_name }}
      target_commitish: ${{ needs.resolve-metadata.outputs.commit }}
      has_linux: ${{ needs.build-linux.result == 'success' }}
      has_windows_mingw: ${{ needs.build-windows-mingw.result == 'success' }}
      has_windows_msvc: ${{ needs.build-windows-msvc.result == 'success' }}
      has_macos: ${{ needs.build-macos.result == 'success' }}