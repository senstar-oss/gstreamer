name: GStreamer Build Dispatcher

on:
  workflow_dispatch:
    inputs:
      build_linux:
        description: 'Build for Linux'
        required: false
        default: true
        type: boolean
      build_windows_mingw:
        description: 'Build for Windows (MinGW/MSYS2)'
        required: false
        default: true
        type: boolean
      build_windows_msvc:
        description: 'Build for Windows (MSVC/Visual Studio)'
        required: false
        default: true
        type: boolean
      build_macos:
        description: 'Build for macOS'
        required: false
        default: true
        type: boolean
      plugins:
        description: 'Comma-separated plugin sets (base,good,bad,ugly,libav)'
        required: false
        default: 'base,good,bad,ugly,libav'
        type: string
      features:
        description: 'Comma-separated features (gpl,webrtc,tests)'
        required: false
        default: 'gpl,webrtc'
        type: string
      build_type:
        description: 'Build type'
        required: false
        default: 'release'
        type: choice
        options:
        - 'release'
        - 'debug'
        - 'both'
      create_release:
        description: 'Create GitHub release (main branch only)'
        required: false
        default: true
        type: boolean

jobs:
  build-linux:
    if: github.event_name != 'workflow_dispatch' || inputs.build_linux
    uses: ./.github/workflows/build-linux.yml
    with:
      plugins: ${{ github.event_name != 'workflow_dispatch' && 'base,good,bad,ugly,libav' || inputs.plugins }}
      features: ${{ github.event_name != 'workflow_dispatch' && 'gpl,webrtc' || inputs.features }}
      build_type: ${{ github.event_name != 'workflow_dispatch' && 'both' || inputs.build_type }}

  build-windows-mingw:
    if: github.event_name != 'workflow_dispatch' || inputs.build_windows_mingw
    uses: ./.github/workflows/build-windows-mingw.yml
    with:
      plugins: ${{ github.event_name != 'workflow_dispatch' && 'base,good,bad,ugly,libav' || inputs.plugins }}
      features: ${{ github.event_name != 'workflow_dispatch' && 'gpl,webrtc' || inputs.features }}
      build_type: ${{ github.event_name != 'workflow_dispatch' && 'release' || inputs.build_type }}

  build-windows-msvc:
    if: github.event_name != 'workflow_dispatch' || inputs.build_windows_msvc
    uses: ./.github/workflows/build-windows-msvc.yml
    with:
      plugins: ${{ github.event_name != 'workflow_dispatch' && 'base,good,bad,ugly,libav' || inputs.plugins }}
      features: ${{ github.event_name != 'workflow_dispatch' && 'gpl,webrtc' || inputs.features }}
      build_type: ${{ github.event_name != 'workflow_dispatch' && 'release' || inputs.build_type }}

  build-macos:
    if: github.event_name != 'workflow_dispatch' || inputs.build_macos
    uses: ./.github/workflows/build-macos.yml
    with:
      plugins: ${{ github.event_name != 'workflow_dispatch' && 'base,good,bad,ugly,libav' || inputs.plugins }}
      features: ${{ github.event_name != 'workflow_dispatch' && 'gpl,webrtc' || inputs.features }}
      build_type: ${{ github.event_name != 'workflow_dispatch' && 'release' || inputs.build_type }}

  verify-plugins:
    needs: [build-linux]
    if: always() && (needs.build-linux.result == 'success')
    uses: ./.github/workflows/verify-plugins.yml

#   create-release:
#     needs: [build-linux, build-windows-mingw, build-windows-msvc, build-macos, verify-plugins]
#     if: >-
#       always() && 
#       (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
#       (github.event_name == 'workflow_dispatch' && inputs.create_release && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
#     uses: ./.github/workflows/create-release.yml
#     with:
#       has_linux: ${{ needs.build-linux.result == 'success' }}
#       has_windows_mingw: ${{ needs.build-windows-mingw.result == 'success' }}
#       has_windows_msvc: ${{ needs.build-windows-msvc.result == 'success' }}
#       has_macos: ${{ needs.build-macos.result == 'success' }}